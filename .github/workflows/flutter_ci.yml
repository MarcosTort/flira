# .github/workflows/pr-review.yml
name: AI PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Environment
      run: |
        source $HOME/ai-review-env/bin/activate
        echo "PATH=$HOME/ai-review-env/bin:$PATH" >> $GITHUB_ENV
        
    - name: Ensure Ollama is running
      run: |
        # Verificar si Ollama estÃ¡ corriendo
        if ! pgrep -x "ollama" > /dev/null; then
          echo "Starting Ollama..."
          ollama serve &
          sleep 10
        fi
        
    - name: Install dependencies
      run: |
        source $HOME/ai-review-env/bin/activate
        pip install -r requirements.txt
        
    - name: Run AI Code Review
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ github.event.number }}
        REPO_NAME: ${{ github.repository }}
        OLLAMA_HOST: "http://localhost:8080"
        OLLAMA_MODEL: "llama2:7b-chat"
      run: |
        source $HOME/ai-review-env/bin/activate
        python scripts/ollama_ai_review.py